<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Algorithm Benchmarks</title>
    <script
      src="https://cdn.jsdelivr.net/npm/plotly.js@3.1.0/dist/plotly.min.js"
      integrity="sha256-Ei4740bWZhaUTQuD6q9yQlgVCMPBz6CZWhevDYPv93A="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.js"
      integrity="sha256-fN8vcX2ULyTDspVTHEteK8hd3rQAb5thNiwakjAW75Q="
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/semantic-ui@2.5.0/dist/semantic.min.css"
      integrity="sha256-cDGQ39yChhpN5vzgHbjIdGEtQ5kXE9tttCsI7VR9TuY="
      crossorigin="anonymous"
    />
    <style>
      .ui.container {
        padding: 2em;
        padding-top: 4em;
      }
      #tree {
        max-width: 600px;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 1em;
      }
      #tree .ui.accordion {
        margin: 0;
      }
      #tree .ui.accordion > .content {
        padding: 0 1.5em;
      }
      #tree .scenario-checkbox {
        display: block !important;
        margin: 0.5em;
      }
      #plot {
        width: 100%;
        min-height: 400px;
      }
      @media (max-width: 1000px) {
        .ui.container {
          width: 100%;
        }
      }
      @media (max-width: 600px) {
        #tree {
          max-width: 100%;
        }
        #plot {
          min-height: 300px;
        }
      }
      .ui.styled.accordion {
        width: initial;
      }
    </style>
  </head>
  <body>
    <div class="ui container">
      <div class="ui grid" style="margin-bottom: 1em">
        <div class="eight wide column">
          <h2 class="ui header">Algorithm Benchmarks</h2>
        </div>
        <div class="eight wide column" style="text-align: right">
          <a href="https://github.com/Zzzzzzyt/algo-benchmarks" class="ui button" target="_blank">
            <i class="github icon"></i>View on GitHub
          </a>
        </div>
      </div>

      <!-- profile and Results Selection -->
      <div class="ui form" style="margin-bottom: 2em">
        <div class="field">
          <label for="profileDropdown">Select profile</label>
          <div class="ui selection dropdown" id="profileDropdown">
            <input type="hidden" name="profile" />
            <i class="dropdown icon"></i>
            <div class="default text">Loading profiles...</div>
            <div class="menu" id="profileMenu"></div>
          </div>
        </div>
      </div>
      <div id="profileInfo" style="margin-bottom: 2em; display: none">
        <div class="ui styled accordion">
          <div class="title">
            <i class="dropdown icon"></i>
            Profile Information
          </div>
          <div class="content">
            <div id="profileDetails"></div>
          </div>
        </div>
      </div>

      <div class="ui grid stackable">
        <div class="four wide column">
          <div class="ui toggle checkbox" style="margin-bottom: 1em">
            <input type="checkbox" id="constantToggle" onchange="refresh()" checked />
            <label for="constantToggle">Use constant</label>
          </div>
          <div class="ui toggle checkbox" style="margin-bottom: 1em">
            <input type="checkbox" id="linesToggle" onchange="refresh()" />
            <label for="linesToggle">Show lines</label>
          </div>
          <div id="tree" class="ui fluid"></div>
        </div>
        <div class="twelve wide column">
          <div id="plot"></div>
          <div id="details" class="ui segment" style="display: none"></div>
        </div>
      </div>
    </div>
    <script>
      let currentResultsData = null;
      let currentProfileData = null;

      // Load results index and populate dropdown
      fetch("results_index.json")
        .then((r) => r.json())
        .then((index) => {
          populateProfileDropdown(index);
          if (index.length > 0) {
            loadProfile(index[0].path, index[0].name);
          }
        })
        .catch(() => {
          // Fallback to direct results.json if index doesn't exist
          fetch("results.json")
            .then((r) => r.json())
            .then((data) => {
              currentResultsData = data;
              window._resultsData = data;
              buildTree(data["results"] || data);
            });
        });

      function populateProfileDropdown(profiles) {
        const menu = document.getElementById("profileMenu");
        const dropdown = document.getElementById("profileDropdown");

        menu.innerHTML = "";
        profiles.forEach((profile) => {
          const item = document.createElement("div");
          item.className = "item";
          item.setAttribute("data-value", profile.path);
          item.textContent = profile.name;
          menu.appendChild(item);
        });

        // Initialize Semantic UI dropdown
        $(dropdown).dropdown({
          onChange: function (value, text) {
            loadProfile(value, text);
          },
        });

        // Update default text
        dropdown.querySelector(".default.text").textContent = "Select an profile";
      }

      function loadProfile(path, name) {
        fetch(path)
          .then((r) => r.json())
          .then((data) => {
            currentResultsData = data.results || data;
            currentProfileData = data;
            window._resultsData = currentResultsData;

            buildTree(currentResultsData);
            displayProfileInfo(data);

            // Set dropdown text
            const dropdown = document.getElementById("profileDropdown");
            dropdown.querySelector(".text").textContent = name;

            refresh();
          })
          .catch((err) => {
            console.error("Failed to load profile:", err);
          });
      }

      function displayProfileInfo(data) {
        const infoDiv = document.getElementById("profileInfo");
        const detailsDiv = document.getElementById("profileDetails");

        infoDiv.style.display = "block";

        let html = "";

        if (data.profile) {
          html += `<div class="ui segment">
              <h5 class="ui header">Profile</h5>
              <p><strong>Name:</strong> ${data.profile.name || "N/A"}</p>
              <p><strong>Build Command:</strong> <code>${data.profile.build_command || "N/A"}</code></p>
            </div>`;
        }

        if (data.environment) {
          const env = data.environment;
          html += `<div class="ui segment">
              <h5 class="ui header">System Information</h5>
              <p><strong>Platform:</strong> ${env.platform || "N/A"}</p>
              <p><strong>Python Version:</strong> ${env.python_version || "N/A"}</p>
            </div>`;
          if (env.meminfo) {
            html += `<div class="ui segment">
                  <h5 class="ui header">Memory Information</h5>
                 <pre style="text-wrap:auto;">${env.meminfo}</pre>
                </div>`;
          }
          if (env.cpuinfo) {
            html += `<div class="ui segment">
                  <h5 class="ui header">CPU Information</h5>
                 <pre style="text-wrap:auto;">${env.cpuinfo}</pre>
                </div>`;
          }
          if (env["g++"]) {
            html += `<div class="ui segment">
                  <h5 class="ui header">Compiler</h5>
                  <pre style="text-wrap:auto;">${env["g++"]}</pre>
                </div>`;
          }
        }

        detailsDiv.innerHTML = html;

        // Initialize accordion
        $(infoDiv).find(".ui.accordion").accordion();
      }

      function buildTree(results) {
        // Build a nested Map tree from keys
        function buildNestedTree(keys) {
          const root = new Map();
          for (const key of keys) {
            const parts = key.split(".");
            let node = root;
            for (let i = 0; i < parts.length - 1; ++i) {
              if (!node.has(parts[i])) node.set(parts[i], new Map());
              node = node.get(parts[i]);
            }
            node.set(parts[parts.length - 1], key);
          }
          return root;
        }

        // Recursively render the tree as Semantic UI accordions
        function renderTree(node) {
          let html = "";
          for (const [k, v] of node.entries()) {
            if (typeof v === "string") {
              // Leaf node as checkbox, with line break
              html += `<div class="ui checkbox scenario-checkbox"><input type="checkbox" id="data-key-${v}"><label for="data-key-${v}">${k}</label></div>`;
            } else {
              html += `<div class="ui accordion"><div class="title"><i class="dropdown icon"></i>${k}</div>`;
              html += '<div class="content">' + renderTree(v) + "</div></div>";
            }
          }
          return html;
        }

        const tree = document.getElementById("tree");
        tree.innerHTML = renderTree(buildNestedTree(Object.keys(results)));

        $("#tree>.accordion").accordion({ exclusive: false, duration: 100 });

        // Checkbox handler for overlaying scenarios
        const checkboxes = tree.querySelectorAll("input[type=checkbox]");
        checkboxes.forEach((cb) => {
          cb.onchange = () => {
            // Get all checked scenarios
            refresh();
          };
        });
      }

      function showOverlayPlot(resultsArr, keysArr) {
        const plotDiv = document.getElementById("plot");
        const detailsDiv = document.getElementById("details");
        const use_c = document.getElementById("constantToggle")?.checked;
        if (!resultsArr.length) {
          plotDiv.innerHTML = "";
          detailsDiv.style.display = "none";
          return;
        }
        // Determine axis scale: log-linear if all are log-linear, else log-log
        let xType = "log";
        let yType = "log";

        const showLines = document.getElementById("linesToggle")?.checked;
        const logRegex = /O\((log n|logn)\)/i;
        if (use_c) {
          yType = "linear";
        } else if (resultsArr.length > 0) {
          const allLogLinear = resultsArr.every((r) => logRegex.test(r.complexity));
          if (allLogLinear) {
            yType = "linear";
          }
        }
        // Build traces for each scenario
        const traces = [];
        const colorScheme = [
          "#1f77b4",
          "#ff7f0e",
          "#2ca02c",
          "#d62728",
          "#9467bd",
          "#8c564b",
          "#e377c2",
          "#7f7f7f",
          "#bcbd22",
          "#17becf",
        ];
        resultsArr.forEach((result, idx) => {
          const xs = [],
            ys = [],
            errors = [];
          result.stats.forEach((d) => {
            const n = Number(d.n);
            if (use_c) {
              ys.push(d.mean_c);
              errors.push(d.stddev_c);
            } else {
              ys.push(d.mean);
              errors.push(d.stddev);
            }
            xs.push(n);
          });

          traces.push({
            x: xs,
            y: ys,
            error_y: { type: "data", array: errors, visible: true },
            mode: showLines ? "lines+markers" : "markers",
            type: "scatter",
            name: keysArr[idx],
            marker: { color: colorScheme[idx % colorScheme.length] },
          });
        });

        // Plotly layout dark mode detection
        const plotLayout = {
          title: keysArr.join(" + "),
          xaxis: { title: "Input size (n)", type: xType },
          yaxis: {
            title: use_c ? "Time / Complexity" : "Time per repeat (ns)",
            type: yType,
          },
          legend: { orientation: "h" },
          margin: { t: 40 },
        };
        Plotly.newPlot(plotDiv, traces, plotLayout, { responsive: true });
        // Details
        detailsDiv.style.display = "";
        detailsDiv.innerHTML = resultsArr
          .map((result, idx) => {
            return [
              `<b>Algorithm:</b> ${keysArr[idx]}`,
              `<b>Type:</b> ${result.type}`,
              `<b>Complexity:</b> ${result.complexity}`,
              `<b>Max Constant:</b> ${typeof result.max_c === "number" ? result.max_c.toFixed(3) : result.max_c}`,
              `<b>Description:</b><br>${result.description_en || "N/A"}`,
            ].join("<br>");
          })
          .join("<hr>");
      }

      function refresh() {
        const tree = document.getElementById("tree");
        const checked = Array.from(tree.querySelectorAll("input[type=checkbox]:checked"));
        const selectedKeys = checked.map((c) => c.id.replace("data-key-", ""));
        if (window._resultsData) {
          showOverlayPlot(
            selectedKeys.map((k) => window._resultsData[k]),
            selectedKeys
          );
        }
      }
    </script>
  </body>
</html>
